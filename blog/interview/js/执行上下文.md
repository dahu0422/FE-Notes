# 执行上下文（Execution Context）
执行上下文是JavaScript中的一个抽象概念，用来描述代码执行时的环境，包括变量、函数定义、this值以及作用域链等信息。

在JavaScript中，每个函数或脚本运行时都会创建一个新的执行上下文。包括：
- 全局执行上下文：是JavaScript引擎在启动时创建的**第一个执行上下文**，它包含全局对象、全局变量、全局函数等。在浏览器中，全局执行上下文是window对象。在Node.js中，全局执行上下文是global对象。
- 函数执行上下文：每个函数被调用时，都会有一个**新的函数执行上下文**被创建，这个上下文包含函数的参数、变量、函数声明、函数体等。函数执行后，对应的函数执行上下文会被销毁，从而释放内存资源。
- `eval()`函数执行上下文：不推荐使用`eval()`函数，因为其执行上下文会一直存在，直到页面被关闭。

## 执行上下文栈
JavaScript引擎使用**栈**来管理执行上下文。

当新的执行上下文被创建时，它会被推到栈顶。当前执行上下文结束时，从栈顶弹出，控制权返回到上一个执行上下文。

全局执行上下文始终位于栈低，是第一个被创建最后一个被销毁的上下文。

## 执行上下文生命周期
执行上下文生命周期分为三分阶段：创建阶段、执行阶段和销毁阶段。

### 创建阶段
JavaScript引擎会为新的执行上下文做一系列准备工作，确保环境就绪。具体包括：
- 初始化变量对象：在ES5时期，这一过程涉及变量和函数声明的提升。在ES6及以后的版本，这一概念被**词法环境**和**变量环境**代替，更精确的管理变量和函数的作用域。
  
  **词法环境**：一种由**标识符——变量映射**的数据结构，标识符是指变量/函数名，变量是对实际对象或原始数据的引用。例如`let name = 'dahu'`，标识符是`name`，引用是1。词法环境由两部分组成：
  - 环境记录：用来存储变量、函数以及其他绑定的集合；
  - 外部环境的引用：指向上一层词法环境的链接，形成了作用域链。使得当前环境找不到变量时，可以从外层环境继续查找。
  
  **变量环境**：专门用来存储变量声明（`var`、`const`、`let`）和`function`声明的。

- 建立作用域链：作用域链是由**当前执行上下文的变量对象**及其**外部上下文的变量对象**组成的链表结构。它决定了变量和函数的访问权限，即在当前上下文中如何查找变量名的绑定。
- 确定`this`的值：this的值根据**执行上下文的类型和调用方式**确定。在全局上下文中，this指向全局对象；在函数上下文中，this的值依赖于函数是如何被调用的。

### 执行阶段
执行上下文被创建后，JavaScript引擎会开始执行上下文中的代码。

### 销毁阶段
当执行上下文中的代码执行完毕，不再有引用指向该执行上下文时，执行上下文会进入销毁阶段。
- 回收资源：执行上下文中的局部变量会被标记为可回收，等待垃圾回收机制进行清理。
- 释放内存：执行上下文被销毁后，内存中的变量对象、词法环境、作用域链等数据结构都会被释放，从而释放内存资源。




