# 执行上下文、作用域、作用域链

## 执行上下文
**执行上下文代表了当前代码被解析和执行时所在的环境**

在JavaScript中每个函数运行时都会创建一个新的执行上下文，分为三种类型：
1. 全局执行上下文：
   - 是JavaScript引擎在启动时创建的**第一个执行上下文**，仅有一个；
   - 在浏览器中，全局执行上下文是**window对象**。在Node.js中，全局执行上下文是global对象；
   - 包含了全局变量和函数的声明；
2. 函数执行上下文：
   - 每个函数被调用时，都会创建一个**新的函数执行上下文**，
   - 函数执行上下文包含了函数的参数、局部变量、函数声明等信息。
   - 函数执行后，对应的函数执行上下文会被销毁，从而释放内存资源。
3. `eval()`函数执行上下文：不推荐使用`eval()`函数，因为其执行上下文会一直存在，直到页面被关闭。

## 执行上下文栈
执行上下文栈（也称为调用栈）是一种**后进先出**的数据结构，用于存储代码执行期间创建的所有执行上下文。

执行上下文栈的逻辑：
1. 当JavaScript引擎首次读取脚本时，它会创建一个全局执行上下文并将其推入执行栈的顶部；
2. 每当调用函数时，都会为该函数创建一个新的执行上下文并将其推入栈顶；
3. 在函数执行完毕后，对应的执行上下文会从栈顶弹出，控制权将移交给当前执行栈的下一个执行上下文。

## 执行上下文生命周期
执行上下文生命周期分为三分阶段：创建阶段、执行阶段、销毁阶段。

### 创建阶段
创建阶段JavaScript引擎会创建变量对象、建立作用域链、确定this指向。
#### 1. 创建变量对象
初始化参数、函数、变量声明，添加进变量对象中，但还未赋值。特别的是`let` 和 `const` 声明的变量不会被添加到变量对象中，涉及到暂时性死区的概念。
#### 2. 建立作用域链
作用域链：是由当**前执行上下文的变量对象**以及其**所有父级（或外部）执行上下文的变量对象**组成的一个链式结构。这个链用于在代码执行过程中解析标识符（如变量名和函数名）的引用。

在创建阶段，JavaScript引擎会根据当前的执行上下文和它的父级执行上下文来构建作用域链。对于全局执行上下文，作用域链只包含全局对象（如浏览器的window对象）。对于函数执行上下文，作用域链会包含函数自身的变量对象以及其父级执行上下文的变量对象。 
#### 3. 确定this指向
对于全局执行上下文，this通常指向全局对象。对于函数执行上下文，this的指向则取决于函数的调用方式。
### 执行阶段
执行上下文被创建后，JavaScript引擎会开始执行上下文中的代码。

### 销毁阶段
当执行上下文中的代码执行完毕，不再有引用指向该执行上下文时，执行上下文会进入销毁阶段。
- 回收资源：执行上下文中的局部变量会被标记为可回收，等待垃圾回收机制进行清理。
- 释放内存：执行上下文被销毁后，内存中的变量对象、词法环境、作用域链等数据结构都会被释放，从而释放内存资源。


## 作用域
通俗理解就是：变量能访问的范围

在JavaScript中作用域分为三种：
1. 全局作用域：最外层的作用域，在全局作用域中声明的变量叫全局变量，挂在window对象上，整个程序中都可以访问。
2. 函数作用域（局部作用域）：
   - 函数作用域是定义在函数内部的变量和函数的作用域。这些变量和函数只能在函数内部被访问，外部无法直接访问。
   - 当函数执行完毕后，其作用域内的变量和函数会被销毁，除非它们被闭包引用。
3. 块级作用域：通过`let` 和 `const` 声明的变量，由于“暂时性死区”，在变量定义前不能访问。
```javascript
console.log(a) //a is not defined
if(true){
let a = '123'；
console.log(a)； // 123
}
console.log(a) //a is not defined
```

## 作用域链
作用域链是JavaScript中用于查找变量的机制。当在函数内部访问一个变量时，JavaScript引擎会首先在当前函数的作用域中查找该变量。如果找不到，它会继续向上在父级作用域中查找，直到找到全局作用域。这个过程形成了一条链式结构，称为作用域链。



