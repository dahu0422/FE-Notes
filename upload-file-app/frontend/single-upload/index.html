<!-- 单文件上传 -->
<!-- 
  界面交互设计：上传元素分为三个元素，分别是选择元素upload-select、进度展示元素upload-progress、上传结果元素upload-result
  默认显示选择元素为upload-select，上传时显示upload-progeress，上传结束显示upload-result

  逻辑设计：通过声明changeArea()方法控制元素的显示
 -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>单文件上传</title>
  <link rel="stylesheet" href="./index.css">
</head>

<body>
  <div class="upload select">
    <div class="upload-select">
      <div>+</div>
      <input type="file" name="file" />
    </div>
    <div class="upload-progress" style="--percent: 0%">
      <div class="progress-bar"></div>
      <button>取消</button>
    </div>
    <div class="upload-result">
      <button>X</button>
    </div>
    <img src="" alt="" width="100%" height="100%">
  </div>
</body>

<script>
  // 初始化需要使用的元素
  const $ = document.querySelector.bind(document)
  const doms = {
    container: $('.upload'),
    select: $('.upload-select'),
    selectFile: $('.upload-select input[type=file]'),
    progress: $('.upload-progress'),
    cancelBtn: $('.upload-progress button'),
    delBtn: $('.upload-result button'),
    img: $('img')
  }

  // 控制切换页面元素显示
  function showArea (areaName) {
    console.log(areaName)
    doms.container.className = `upload ${areaName}`
  }

  // 设计进度更改
  function setProgress (value) {
    doms.progress.style.setProperty('--percent', `${value}%`)
  }

  // 监听upload-select元素点击事件，点击后触selecFile元素的click事件
  doms.select.addEventListener('click', () => {
    doms.selectFile.click()
  })

  let cancelUpload = null
  function cancel () {
    cancelUpload && cancelUpload()
    showArea('select')
    doms.selectFile.value = null
  }

  // 监听文件选择事件，文件选择后触发上传
  doms.selectFile.addEventListener('change', (e) => {
    showArea('progress')
    const file = e.target.files[0]
    const reader = new FileReader()
    reader.onload = (e) => {
      doms.img.src = e.target.result
    }
    reader.readAsDataURL(file)
    cancelUpload = upload(file, function (val) {
      setProgress(val)
    }, function (resp) {
      showArea('result')
    })
  })

  function upload (file, onProgress, onFinish) {
    const form = new FormData()
    form.append('file', file)
    // fetch没有load、progress事件，所以用xhr记录事件
    const xhr = new XMLHttpRequest()
    xhr.open('POST', 'http://localhost:3000/api/v1/upload/single')
    // 监听完成时间
    xhr.onload = function () {
      const resp = JSON.parse(xhr.responseText)
      onFinish(resp)
    }
    xhr.upload.onprogress = function (e) {
      const percent = Math.floor(e.loaded / e.total * 100)
      onProgress(percent)
    }
    xhr.send(form)
    return function () {
      xhr.abort()
    }
    // fetch('http://localhost:3000/api/v1/upload/single', {
    //   method: 'POST',
    //   body: form,
    // })
    // let p = 0
    // onProgress(0)
    // const timerId = setInterval(() => {
    //   p++
    //   if (p === 100) {
    //     clearInterval(timerId)
    //     onFinish()
    //   }
    //   onProgress(p)
    // }, 50)
    // return function () {
    //   clearInterval(timerId)
    // }
  }
  // 点击取消上传按钮清空定时器
  doms.cancelBtn.addEventListener('click', () => {
    cancel()
  })
  // 点击删除按钮隐藏图片
  doms.delBtn.addEventListener('click', () => {
    cancel()
  })
</script>

</html>